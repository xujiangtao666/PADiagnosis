{% extends 'index.html' %}
{% load static %}

{% block title %}åŒ»å­¦å½±åƒé¢„è§ˆ - {{ patient_info.image_style }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'patient_records:patient_list' %}">æ‚£è€…åŒ»å­¦å›¾åƒç®¡ç†</a></li>
<li class="breadcrumb-item"><a href="{% url 'patient_records:ultrasound_viewer' patient_info_id %}">å½±åƒæŸ¥çœ‹å™¨</a></li>
<li class="breadcrumb-item active" aria-current="page">å½±åƒé¢„è§ˆ</li>
{% endblock %}

{% block page_css %}
    <style>
    :root {
        --medical-primary: #5ba3e6;
        --medical-secondary: #87ceeb;
        --medical-accent: #b3d9ff;
        --medical-light: #f8fcff;
        --medical-success: #90cdf4;
        --medical-warning: #ffd93d;
        --medical-danger: #ff8a95;
        --gradient-medical: linear-gradient(135deg, #87ceeb 0%, #b3d9ff 100%);
        --gradient-soft: linear-gradient(135deg, #ffffff 0%, #f0f8ff 100%);
        --shadow-light: 0 2px 15px rgba(91, 163, 230, 0.08);
        --shadow-medium: 0 5px 25px rgba(91, 163, 230, 0.12);
        --shadow-heavy: 0 10px 40px rgba(91, 163, 230, 0.15);
        --text-primary: #2d5aa0;
        --text-secondary: #5b7db8;
        --text-muted: #8da4c7;
        --bg-card: #ffffff;
        --bg-hover: rgba(91, 163, 230, 0.05);
    }

    body {
        background: var(--medical-light);
        font-family: 'Segoe UI', system-ui, sans-serif;
    }
    
    .preview-container {
        background: var(--bg-card);
        border-radius: 16px;
        padding: 2.5rem;
        margin: 2rem 0;
        box-shadow: var(--shadow-medium);
        border: 1px solid rgba(91, 163, 230, 0.08);
    }
    
    .page-header {
        background: var(--bg-card);
        border-radius: 16px;
        padding: 1.5rem 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-light);
        border-left: 4px solid var(--medical-primary);
        border: 1px solid rgba(91, 163, 230, 0.08);
    }
    
    .page-title {
        color: var(--text-primary);
        font-weight: 700;
        font-size: 1.8rem;
        margin: 0;
    }
    
    .breadcrumb {
        background: transparent;
        margin: 0;
        padding: 0;
    }
    
    .breadcrumb-item a {
        color: var(--medical-primary);
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s ease;
    }
    
    .breadcrumb-item a:hover {
        color: var(--text-primary);
    }
    
    .breadcrumb-item.active {
        color: var(--text-secondary);
        font-weight: 600;
    }
    
    .back-btn {
        background: var(--bg-card);
        border: 2px solid var(--medical-primary);
        border-radius: 30px;
        padding: 12px 28px;
        color: var(--medical-primary);
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        transition: all 0.3s ease;
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-light);
    }
    
    .back-btn:hover {
        background: var(--gradient-medical);
        color: var(--text-primary);
        transform: translateY(-2px);
        text-decoration: none;
        box-shadow: var(--shadow-medium);
    }
    
    .patient-summary {
        background: var(--gradient-medical);
        color: var(--text-primary);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-medium);
        border: 1px solid rgba(91, 163, 230, 0.1);
    }
    
    .patient-summary h5 {
        margin-bottom: 1rem;
        font-weight: 700;
    }
    
    .patient-summary .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }
    
    .patient-summary .info-item {
        background: rgba(255, 255, 255, 0.6);
        border: 1px solid rgba(255, 255, 255, 0.8);
        border-radius: 8px;
        padding: 1rem;
    }
    
    .patient-summary .info-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 500;
    }
    
    .patient-summary .info-value {
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .viewer-wrapper {
        background: var(--bg-card);
        border-radius: 16px;
        padding: 0;
        box-shadow: var(--shadow-medium);
        border: 1px solid rgba(91, 163, 230, 0.08);
        min-height: 600px;
        position: relative;
        overflow: hidden;
    }
    
    .viewer-header {
        background: var(--gradient-soft);
        padding: 1.5rem 2rem;
        border-bottom: 1px solid rgba(91, 163, 230, 0.1);
        display: flex;
        justify-content: between;
        align-items: center;
    }
    
    .viewer-title {
        color: var(--text-primary);
        font-weight: 700;
        margin: 0;
        display: flex;
        align-items: center;
    }
    
    .viewer-controls {
        display: flex;
        gap: 1rem;
        align-items: center;
    }
    
    .control-btn {
        background: var(--bg-card);
        border: 1px solid var(--medical-primary);
        border-radius: 8px;
        padding: 8px 16px;
        color: var(--medical-primary);
        font-size: 0.9rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .control-btn:hover {
        background: var(--medical-primary);
        color: white;
    }
    
    .viewer-content {
        padding: 2rem;
        min-height: 500px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    
    .loading-spinner {
        width: 60px;
        height: 60px;
        border: 4px solid var(--medical-accent);
        border-top: 4px solid var(--medical-primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .progress-container {
        width: 300px;
        height: 6px;
        background: rgba(91, 163, 230, 0.2);
        border-radius: 3px;
        overflow: hidden;
        margin: 1rem 0;
    }
    
    .progress-bar {
        height: 100%;
        background: var(--gradient-medical);
        border-radius: 3px;
        animation: loading-progress 3s ease-in-out;
        transform-origin: left;
    }
    
    @keyframes loading-progress {
        0% { transform: scaleX(0); }
        50% { transform: scaleX(0.7); }
        90% { transform: scaleX(0.9); }
        100% { transform: scaleX(1); }
    }
    
    .pulse-dot {
        display: inline-block;
        animation: pulse-dots 1.4s infinite;
    }
    
    .pulse-dot:nth-child(2) { animation-delay: 0.2s; }
    .pulse-dot:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes pulse-dots {
        0%, 60%, 100% { opacity: 0.3; }
        30% { opacity: 1; }
    }
    
    .file-info-card {
        background: var(--gradient-soft);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        border: 1px solid rgba(91, 163, 230, 0.1);
    }
    
    .file-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
    }
    
    .file-info-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .file-info-icon {
        width: 40px;
        height: 40px;
        background: var(--medical-primary);
        color: white;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
    }
    
    .file-info-text {
        flex: 1;
    }
    
    .file-info-label {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin-bottom: 0.25rem;
        font-weight: 500;
    }
    
    .file-info-value {
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .action-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
        margin-top: 2rem;
    }
    
    .action-btn {
        background: var(--gradient-medical);
        border: none;
        border-radius: 30px;
        padding: 12px 24px;
        color: var(--text-primary);
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-light);
        font-size: 1rem;
    }
    
    .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
        color: var(--text-primary);
        text-decoration: none;
    }
    
    .action-btn.primary {
        background: var(--medical-primary);
        color: white;
    }
    
    .action-btn.primary:hover {
        background: var(--text-primary);
        color: white;
    }
    
    .nifti-viewer {
        width: 100%;
        height: 500px;
        border: 1px solid rgba(91, 163, 230, 0.2);
        border-radius: 8px;
        background: #000;
        position: relative;
    }
    
    .viewer-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        color: var(--text-muted);
        text-align: center;
    }
    
    .viewer-placeholder i {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: var(--medical-primary);
    }
    
    .error-message {
        background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        color: #c62828;
        padding: 1rem;
        border-radius: 8px;
        margin: 1rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="page-title">
                    <i class="bi bi-eye me-3"></i>åŒ»å­¦å½±åƒé¢„è§ˆ
                </h1>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'patient_records:patient_list' %}">æ‚£è€…åŒ»å­¦å›¾åƒç®¡ç†</a></li>
                        {% if patient_info_id %}
                        <li class="breadcrumb-item"><a href="{% url 'patient_records:ultrasound_viewer' patient_info_id %}">å½±åƒæŸ¥çœ‹å™¨</a></li>
                        {% else %}
                        <li class="breadcrumb-item">å½±åƒæŸ¥çœ‹å™¨ (IDé”™è¯¯)</li>
                        {% endif %}
                        <li class="breadcrumb-item active" aria-current="page">å½±åƒé¢„è§ˆ</li>
                    </ol>
                </nav>
                <!-- Debug info -->
                <small class="text-muted">Debug: patient_info_id={{ patient_info_id }}, patient_id={{ patient_id }}</small>
            </div>
            {% if patient_info_id %}
            <a href="{% url 'patient_records:ultrasound_viewer' patient_info_id %}" class="back-btn">
                <i class="bi bi-arrow-left me-2"></i>è¿”å›æŸ¥çœ‹å™¨
            </a>
            {% else %}
            <a href="{% url 'patient_records:patient_list' %}" class="back-btn">
                <i class="bi bi-arrow-left me-2"></i>è¿”å›åˆ—è¡¨
            </a>
            {% endif %}
        </div>
    </div>
    
    <!-- æ‚£è€…ä¿¡æ¯æ‘˜è¦ -->
    <div class="patient-summary">
        <h5><i class="bi bi-person-badge me-2"></i>æ‚£è€…ä¿¡æ¯</h5>
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">æ‚£è€…ID</div>
                <div class="info-value">{{ patient_info.patient_id }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">å½±åƒç±»å‹</div>
                <div class="info-value">
                    {% if patient_info.image_style == 'US' %}è¶…å£° (US)
                    {% elif patient_info.image_style == 'CT' %}CTæ‰«æ
                    {% elif patient_info.image_style == 'MRI' %}æ ¸ç£å…±æŒ¯ (MRI)
                    {% elif patient_info.image_style == 'X-ray' %}Xå…‰
                    {% else %}{{ patient_info.image_style }}
                    {% endif %}
                </div>
            </div>
            <div class="info-item">
                <div class="info-label">ä¸Šä¼ æ—¶é—´</div>
                <div class="info-value">{{ patient_info.created_at|date:"Y-m-d H:i" }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">åˆ›å»ºåŒ»ç”Ÿ</div>
                <div class="info-value">{{ patient_info.created_by.full_name }}</div>
            </div>
        </div>
    </div>
    
    <!-- æ–‡ä»¶ä¿¡æ¯å¡ç‰‡ -->
    <div class="file-info-card">
        <h6 style="color: var(--text-primary); font-weight: 600; margin-bottom: 1.5rem;">
            <i class="bi bi-file-earmark-medical me-2"></i>æ–‡ä»¶è¯¦ç»†ä¿¡æ¯
        </h6>
        <div class="file-info-grid">
            <div class="file-info-item">
                <div class="file-info-icon">
                    <i class="bi bi-file-earmark"></i>
                </div>
                <div class="file-info-text">
                    <div class="file-info-label">æ–‡ä»¶æ ¼å¼</div>
                    <div class="file-info-value">NIfTI (.nii.gz)</div>
                </div>
            </div>
            <div class="file-info-item">
                <div class="file-info-icon">
                    <i class="bi bi-hdd"></i>
                </div>
                <div class="file-info-text">
                    <div class="file-info-label">æ–‡ä»¶å¤§å°</div>
                    <div class="file-info-value">
                        {% if file_size %}
                            {% if file_size > 1048576 %}
                                {{ file_size|filesizeformat }}
                            {% else %}
                                {{ file_size|filesizeformat }}
                            {% endif %}
                        {% else %}
                            æœªçŸ¥
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="file-info-item">
                <div class="file-info-icon">
                    <i class="bi bi-layers"></i>
                </div>
                <div class="file-info-text">
                    <div class="file-info-label">æ•°æ®ç±»å‹</div>
                    <div class="file-info-value">3DåŒ»å­¦å½±åƒä½“ç§¯</div>
                </div>
            </div>
            <div class="file-info-item">
                <div class="file-info-icon">
                    <i class="bi bi-cpu"></i>
                </div>
                <div class="file-info-text">
                    <div class="file-info-label">æ¸²æŸ“æ¨¡å¼</div>
                    <div class="file-info-value">WebGL ä¸‰ç»´å¯è§†åŒ–</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- å½±åƒæŸ¥çœ‹å™¨ -->
    <div class="viewer-wrapper">
        <div class="viewer-header">
            <h6 class="viewer-title">
                <i class="bi bi-eye me-2"></i>NIfTI åŒ»å­¦å½±åƒæŸ¥çœ‹å™¨
            </h6>
            <div class="viewer-controls">
                <button class="control-btn" onclick="resetView()">
                    <i class="bi bi-arrow-clockwise me-1"></i>é‡ç½®è§†å›¾
                </button>
                <button class="control-btn" onclick="toggleFullscreen()">
                    <i class="bi bi-fullscreen me-1"></i>å…¨å±
                </button>
            </div>
        </div>
        <div class="viewer-content">
            <div id="nifti-viewer" class="nifti-viewer">
                <!-- åŠ è½½çŠ¶æ€ -->
                <div class="viewer-placeholder" id="loading-placeholder">
                    <div class="loading-spinner"></div>
                    <h5 id="loading-title">æ­£åœ¨åŠ è½½åŒ»å­¦å½±åƒ</h5>
                    <div class="progress-container">
                        <div class="progress-bar"></div>
                    </div>
                    <p id="loading-text">
                        æ­£åœ¨è§£æNIfTIæ–‡ä»¶æ ¼å¼
                        <span class="pulse-dot">.</span>
                        <span class="pulse-dot">.</span>
                        <span class="pulse-dot">.</span>
                    </p>
                </div>
                
                <!-- 2Dåˆ‡ç‰‡æŸ¥çœ‹å™¨ -->
                <div id="slice-viewer" style="display: none; height: 100%; background: #000;">
                    <!-- é¡¶éƒ¨å·¥å…·æ  -->
                    <div class="d-flex justify-content-between align-items-center p-2" style="background: rgba(30, 30, 30, 0.9); border-bottom: 1px solid rgba(255,255,255,0.1);">
                        <div class="d-flex align-items-center text-white">
                            <i class="bi bi-layers me-2"></i>
                            <span id="slice-info">åˆ‡ç‰‡ 1 / 100</span>
                            <span class="ms-3 text-muted" id="view-plane-info">è½´ä½è§†å›¾</span>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <!-- è§†å›¾æ–¹å‘é€‰æ‹© -->
                            <div class="btn-group btn-group-sm" role="group">
                                <input type="radio" class="btn-check" name="view-plane" id="axial-view" value="axial" checked>
                                <label class="btn btn-outline-light" for="axial-view" style="font-size: 0.75rem;">è½´ä½</label>
                                
                                <input type="radio" class="btn-check" name="view-plane" id="sagittal-view" value="sagittal">
                                <label class="btn btn-outline-light" for="sagittal-view" style="font-size: 0.75rem;">çŸ¢çŠ¶ä½</label>
                                
                                <input type="radio" class="btn-check" name="view-plane" id="coronal-view" value="coronal">
                                <label class="btn btn-outline-light" for="coronal-view" style="font-size: 0.75rem;">å† çŠ¶ä½</label>
                            </div>
                            
                            <!-- çª—å®½çª—ä½æ˜¾ç¤º -->
                            <div class="text-white" style="font-size: 0.75rem;">
                                <span>W/L: </span><span id="window-level-info">400/40</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ä¸»æ˜¾ç¤ºåŒºåŸŸ -->
                    <div class="position-relative" style="height: calc(100% - 100px); overflow: hidden;">
                        <!-- å›¾åƒCanvas -->
                        <div class="d-flex align-items-center justify-content-center h-100">
                            <canvas id="slice-canvas" style="max-width: 100%; max-height: 100%; image-rendering: pixelated;"></canvas>
                        </div>
                        
                        <!-- å›¾åƒä¿¡æ¯è¦†ç›–å±‚ -->
                        <div id="image-overlay" class="position-absolute text-white" style="
                            top: 10px; right: 10px; 
                            background: rgba(0,0,0,0.8); 
                            padding: 8px 12px; 
                            border-radius: 6px;
                            font-size: 0.75rem;
                            line-height: 1.4;
                        ">
                            <div><strong>{{ patient_info.patient_id }}</strong></div>
                            <div>ç»´åº¦: <span id="dimensions-display">-</span></div>
                            <div>é—´è·: <span id="spacing-display">-</span></div>
                            <div>ç±»å‹: <span id="datatype-display">-</span></div>
                        </div>
                        
                        <!-- åˆ‡ç‰‡ä½ç½®æŒ‡ç¤ºå™¨ -->
                        <div id="slice-position" class="position-absolute text-white" style="
                            bottom: 10px; left: 10px;
                            background: rgba(0,0,0,0.8);
                            padding: 6px 10px;
                            border-radius: 4px;
                            font-size: 0.8rem;
                        ">
                            <span id="current-slice">0</span> / <span id="total-slices">0</span>
                        </div>
                    </div>
                    
                    <!-- åº•éƒ¨æ§åˆ¶æ  -->
                    <div class="p-2" style="background: rgba(30, 30, 30, 0.9); border-top: 1px solid rgba(255,255,255,0.1);">
                        <!-- åˆ‡ç‰‡å¯¼èˆª -->
                        <div class="d-flex align-items-center">
                            <button id="first-slice-btn" class="btn btn-outline-light btn-sm me-1" style="font-size: 0.7rem; padding: 2px 6px;">
                                <i class="bi bi-skip-start"></i>
                            </button>
                            <button id="prev-slice-btn" class="btn btn-outline-light btn-sm me-2" style="font-size: 0.7rem; padding: 2px 6px;">
                                <i class="bi bi-chevron-left"></i>
                            </button>
                            
                            <div class="flex-grow-1 mx-2">
                                <input type="range" id="slice-slider" class="form-range" min="0" max="99" value="0" 
                                       style="accent-color: var(--medical-primary); height: 6px;">
                            </div>
                            
                            <button id="next-slice-btn" class="btn btn-outline-light btn-sm ms-2" style="font-size: 0.7rem; padding: 2px 6px;">
                                <i class="bi bi-chevron-right"></i>
                            </button>
                            <button id="last-slice-btn" class="btn btn-outline-light btn-sm ms-1" style="font-size: 0.7rem; padding: 2px 6px;">
                                <i class="bi bi-skip-end"></i>
                            </button>
                            
                            <!-- å¿«æ·æ“ä½œ -->
                            <div class="ms-3 d-flex gap-1">
                                <button id="reset-view-btn" class="btn btn-outline-info btn-sm" style="font-size: 0.7rem; padding: 2px 8px;">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                                <button id="save-slice-btn" class="btn btn-outline-success btn-sm" style="font-size: 0.7rem; padding: 2px 8px;">
                                    <i class="bi bi-download"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ“ä½œæŒ‰é’® -->
    <div class="action-buttons">
        {% if patient_info_id %}
        <a href="{% url 'patient_records:ultrasound_viewer' patient_info_id %}" class="action-btn">
            <i class="bi bi-arrow-left me-2"></i>è¿”å›æŸ¥çœ‹å™¨
        </a>
        {% else %}
        <a href="{% url 'patient_records:patient_list' %}" class="action-btn">
            <i class="bi bi-arrow-left me-2"></i>è¿”å›åˆ—è¡¨
        </a>
        {% endif %}
        <a href="{{ patient_info.image.url }}" download class="action-btn primary">
            <i class="bi bi-download me-2"></i>ä¸‹è½½åŸå§‹æ–‡ä»¶
        </a>
        <button class="action-btn" onclick="captureScreenshot()">
            <i class="bi bi-camera me-2"></i>æˆªå›¾ä¿å­˜
        </button>
    </div>
</div>

<!-- æœ¬åœ°NIfTIè§£æå™¨ -->
<script>
// ç®€åŒ–çš„NIfTIæ–‡ä»¶æ ¼å¼è§£æå™¨
class SimpleNiftiReader {
    static readHeader(buffer) {
        const view = new DataView(buffer);
        const header = {};
        
        // NIfTI-1 header structure (simplified)
        header.sizeof_hdr = view.getInt32(0, true);
        header.dim = [];
        for (let i = 0; i < 8; i++) {
            header.dim[i] = view.getInt16(40 + i * 2, true);
        }
        header.datatype = view.getInt16(70, true);
        header.bitpix = view.getInt16(72, true);
        header.pixdim = [];
        for (let i = 0; i < 8; i++) {
            header.pixdim[i] = view.getFloat32(76 + i * 4, true);
        }
        header.vox_offset = view.getFloat32(108, true);
        header.scl_slope = view.getFloat32(112, true);
        header.scl_inter = view.getFloat32(116, true);
        
        // éªŒè¯NIfTIé­”æ•°
        const magic = String.fromCharCode(
            view.getUint8(344), view.getUint8(345), 
            view.getUint8(346), view.getUint8(347)
        );
        header.magic = magic;
        header.isValid = magic === 'ni1\0' || magic === 'n+1\0';
        
        return header;
    }
    
    static isCompressed(buffer) {
        // æ£€æŸ¥æ–‡ä»¶å¼€å¤´æ˜¯å¦ä¸ºgzipé­”æ•°
        const view = new Uint8Array(buffer, 0, 2);
        return view[0] === 0x1f && view[1] === 0x8b;
    }
    
    static decompress(buffer) {
        // ä½¿ç”¨pakoåº“è§£å‹æˆ–æç¤ºç”¨æˆ·
        if (typeof pako !== 'undefined') {
            return pako.inflate(buffer).buffer;
        } else {
            throw new Error('éœ€è¦è§£å‹åº“æ¥å¤„ç†.gzæ–‡ä»¶');
        }
    }
    
    static readImage(header, buffer) {
        const offset = header.vox_offset || 352;
        const dataSize = header.dim[1] * header.dim[2] * header.dim[3];
        
        let imageData;
        switch (header.datatype) {
            case 2: // unsigned char
                imageData = new Uint8Array(buffer, offset, dataSize);
                break;
            case 4: // signed short
                imageData = new Int16Array(buffer, offset, dataSize);
                break;
            case 8: // signed int
                imageData = new Int32Array(buffer, offset, dataSize);
                break;
            case 16: // float
                imageData = new Float32Array(buffer, offset, dataSize);
                break;
            case 64: // double
                imageData = new Float64Array(buffer, offset, dataSize);
                break;
            default:
                imageData = new Uint8Array(buffer, offset, dataSize);
        }
        
        return imageData;
    }
}

// è®¾ç½®å…¨å±€niftiå¯¹è±¡
window.nifti = SimpleNiftiReader;
window.niftiLoaded = true;
console.log('âœ… æœ¬åœ°NIfTIè§£æå™¨å·²åŠ è½½');
</script>
<!-- è§£å‹åº“ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js" onload="console.log('âœ… Pakoè§£å‹åº“åŠ è½½æˆåŠŸ')" onerror="console.log('âŒ Pakoè§£å‹åº“åŠ è½½å¤±è´¥')"></script>
<!-- Three.js å’Œç›¸å…³åº“ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" onload="console.log('âœ… Three.jsåŠ è½½æˆåŠŸ')" onerror="console.log('âŒ Three.jsåŠ è½½å¤±è´¥')"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js" onload="console.log('âœ… OrbitControlsåŠ è½½æˆåŠŸ')" onerror="console.log('âŒ OrbitControlsåŠ è½½å¤±è´¥')"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('é¡µé¢DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–æŸ¥çœ‹å™¨');
    
    // ç«‹å³æ£€æŸ¥åº“çŠ¶æ€
    console.log('ç«‹å³æ£€æŸ¥åº“çŠ¶æ€:', {
        THREE: !!window.THREE,
        OrbitControls: !!(window.THREE && window.THREE.OrbitControls),
        nifti: !!window.nifti,
        document_ready: document.readyState
    });
    
    // æ›´æ–°åŠ è½½çŠ¶æ€
    function updateLoadingStatus(status) {
        const titleEl = document.getElementById('loading-title');
        const textEl = document.getElementById('loading-text');
        if (titleEl) titleEl.textContent = status.title;
        if (textEl) {
            textEl.innerHTML = status.text + 
                '<span class="pulse-dot">.</span>' +
                '<span class="pulse-dot">.</span>' +
                '<span class="pulse-dot">.</span>';
        }
        console.log('æ›´æ–°åŠ è½½çŠ¶æ€:', status);
    }
    
    // ç®€åŒ–çš„åº“æ£€æŸ¥é€»è¾‘
    let checkAttempts = 0;
    
    function checkLibrariesAndInit() {
        checkAttempts++;
        console.log(`æ£€æŸ¥å°è¯• #${checkAttempts}`);
        
        const hasThree = !!(window.THREE);
        const hasOrbitControls = !!(window.THREE && window.THREE.OrbitControls);
        const hasNifti = !!(window.nifti) || window.niftiLoaded === true;
        
        console.log('å½“å‰åº“çŠ¶æ€:', { 
            hasThree, 
            hasOrbitControls, 
            hasNifti,
            niftiGlobal: !!window.nifti,
            niftiLoaded: window.niftiLoaded,
            niftiAttempts: window.niftiLoadAttempts
        });
        
        if (hasThree && hasOrbitControls && hasNifti) {
            console.log('âœ… æ‰€æœ‰åº“å·²åŠ è½½ï¼åˆå§‹åŒ–NIfTIæŸ¥çœ‹å™¨');
            updateLoadingStatus({
                title: 'åº“åŠ è½½å®Œæˆ',
                text: 'æ­£åœ¨åˆå§‹åŒ–åŒ»å­¦å½±åƒæŸ¥çœ‹å™¨'
            });
            setTimeout(() => initNiftiViewer(), 100);
        } else if (checkAttempts >= 8) {  // 1.6ç§’åæ”¾å¼ƒ
            console.log('â° åº“åŠ è½½è¶…æ—¶ï¼Œåˆ‡æ¢åˆ°ç®€åŒ–æŸ¥çœ‹å™¨');
            updateLoadingStatus({
                title: 'åˆ‡æ¢åˆ°ç®€åŒ–æ¨¡å¼',
                text: 'æ­£åœ¨å‡†å¤‡æ–‡ä»¶æŸ¥çœ‹å™¨'
            });
            setTimeout(() => {
                initSimpleViewer();
                viewerInitialized = true;
            }, 200);
        } else {
            // ç»§ç»­ç­‰å¾…
            updateLoadingStatus({
                title: `æ­£åœ¨åŠ è½½ç¬¬ä¸‰æ–¹åº“ (${checkAttempts}/10)`,
                text: 'åŠ è½½WebGLå’ŒNIfTIè§£æå™¨'
            });
            setTimeout(checkLibrariesAndInit, 200);
        }
    }
    
    // ç«‹å³å¼€å§‹æ£€æŸ¥
    updateLoadingStatus({
        title: 'æ­£åœ¨åˆå§‹åŒ–æŸ¥çœ‹å™¨',
        text: 'æ£€æŸ¥å¿…éœ€ç»„ä»¶'
    });
    
    checkLibrariesAndInit();
});

// 2Dåˆ‡ç‰‡æŸ¥çœ‹å™¨å…¨å±€å˜é‡
let volumeData = null;
let currentSlice = 0;
let currentPlane = 'axial'; // 'axial', 'sagittal', 'coronal'
let canvas, ctx;
let imageData = null;
let header = null;
let windowWidth = 400, windowLevel = 40;

function initNiftiViewer() {
    if (viewerInitialized) return;
    
    try {
        console.log('å¼€å§‹åˆå§‹åŒ–2DåŒ»å­¦å½±åƒæŸ¥çœ‹å™¨');
        viewerInitialized = true;
        
        // åŠ è½½çœŸå®çš„NIfTIæ–‡ä»¶
        loadNiftiFile('{{ image_url }}');
        
        console.log('âœ… 2Dåˆ‡ç‰‡æŸ¥çœ‹å™¨åˆå§‹åŒ–å®Œæˆ');
        
    } catch (error) {
        console.error('åˆå§‹åŒ–æŸ¥çœ‹å™¨å¤±è´¥:', error);
        viewerInitialized = false;  // é‡ç½®çŠ¶æ€ï¼Œå…è®¸ç®€åŒ–æŸ¥çœ‹å™¨åˆå§‹åŒ–
        // å¦‚æœWebGLåˆå§‹åŒ–å¤±è´¥ï¼Œä½¿ç”¨ç®€åŒ–æŸ¥çœ‹å™¨
        setTimeout(() => {
            if (!viewerInitialized) {
                initSimpleViewer();
                viewerInitialized = true;
            }
        }, 100);
    }
}

// å…¨å±€çŠ¶æ€
let viewerInitialized = false;

// 1.5ç§’åå¼ºåˆ¶ä½¿ç”¨ç®€åŒ–æŸ¥çœ‹å™¨ï¼ˆä¿é™©æœºåˆ¶ï¼‰
setTimeout(function() {
    if (!viewerInitialized) {
        console.log('ğŸš¨ å¼ºåˆ¶è¶…æ—¶ä¿æŠ¤ï¼šç«‹å³æ˜¾ç¤ºç®€åŒ–æŸ¥çœ‹å™¨');
        initSimpleViewer();
        viewerInitialized = true;
    }
}, 1500);

function createDemoMedicalVisualization() {
    try {
        // åˆ›å»ºä¸€ä¸ªä»£è¡¨åŒ»å­¦å›¾åƒçš„3Då‡ ä½•ä½“
        const geometry = new THREE.BoxGeometry(100, 100, 100);
        
        // åˆ›å»ºåŠé€æ˜æè´¨
        const material = new THREE.MeshPhongMaterial({
            color: 0x5ba3e6,
            transparent: true,
            opacity: 0.6,
            wireframe: false
        });
        
        const cube = new THREE.Mesh(geometry, material);
        scene.add(cube);
        
        // æ·»åŠ ä¸€äº›å†…éƒ¨ç»“æ„ï¼ˆæ¨¡æ‹ŸåŒ»å­¦å›¾åƒå†…å®¹ï¼‰
        for (let i = 0; i < 20; i++) {
            const sphereGeometry = new THREE.SphereGeometry(3, 8, 6);
            const sphereMaterial = new THREE.MeshPhongMaterial({
                color: Math.random() * 0xffffff,
                transparent: true,
                opacity: 0.8
            });
            
            const sphere = new THREE.Mesh(sphereGeometry, sphereMaterial);
            sphere.position.set(
                (Math.random() - 0.5) * 80,
                (Math.random() - 0.5) * 80,
                (Math.random() - 0.5) * 80
            );
            scene.add(sphere);
        }
        
        // æ·»åŠ è¾¹æ¡†
        const edges = new THREE.EdgesGeometry(geometry);
        const lineMaterial = new THREE.LineBasicMaterial({ color: 0x2d5aa0 });
        const wireframe = new THREE.LineSegments(edges, lineMaterial);
        scene.add(wireframe);
        
        console.log('âœ… åˆ›å»ºäº†æ¼”ç¤ºåŒ»å­¦å¯è§†åŒ–');
        
        // æ·»åŠ è¯´æ˜æ–‡å­—åˆ°é¡µé¢
        const container = document.getElementById('nifti-viewer');
        const overlay = document.createElement('div');
        overlay.style.cssText = `
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(45, 90, 160, 0.9);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            z-index: 100;
            max-width: 300px;
        `;
        overlay.innerHTML = `
            <strong>ğŸ”¬ æ¼”ç¤ºæ¨¡å¼</strong><br>
            è¿™æ˜¯ä¸€ä¸ª3D WebGLæ¼”ç¤ºã€‚<br>
            æ‹–æ‹½æ—‹è½¬ï¼Œæ»šè½®ç¼©æ”¾ã€‚<br>
            <small>å®é™…NIfTIæ–‡ä»¶éœ€è¦ä¸“ä¸šè½¯ä»¶å¤„ç†</small>
        `;
        container.appendChild(overlay);
        
    } catch (error) {
        console.error('åˆ›å»ºæ¼”ç¤ºå¯è§†åŒ–å¤±è´¥:', error);
    }
}

function loadNiftiFile(url) {
    console.log('å¼€å§‹åŠ è½½NIfTIæ–‡ä»¶:', url);
    
    fetch(url)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.arrayBuffer();
        })
        .then(buffer => {
            try {
                console.log('æ–‡ä»¶å·²ä¸‹è½½ï¼Œå¤§å°:', buffer.byteLength, 'bytes');
                
                let workingBuffer = buffer;
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºå‹ç¼©æ–‡ä»¶
                if (window.nifti.isCompressed(buffer)) {
                    console.log('æ£€æµ‹åˆ°.gzå‹ç¼©æ–‡ä»¶ï¼Œæ­£åœ¨è§£å‹...');
                    if (typeof pako !== 'undefined') {
                        const decompressed = pako.inflate(new Uint8Array(buffer));
                        workingBuffer = decompressed.buffer;
                        console.log('è§£å‹å®Œæˆï¼Œè§£å‹åå¤§å°:', workingBuffer.byteLength, 'bytes');
                    } else {
                        throw new Error('éœ€è¦è§£å‹åº“æ¥å¤„ç†.gzæ–‡ä»¶ï¼Œä½†pakoåº“æœªåŠ è½½');
                    }
                }
                
                // è§£æNIfTIæ–‡ä»¶å¤´
                header = window.nifti.readHeader(workingBuffer);
                console.log('NIfTI Headerè§£æå®Œæˆ:', header);
                
                if (!header.isValid) {
                    throw new Error(`æ— æ•ˆçš„NIfTIæ–‡ä»¶æ ¼å¼ï¼Œé­”æ•°: ${header.magic}`);
                }
                
                // è¯»å–å›¾åƒæ•°æ®
                imageData = window.nifti.readImage(header, workingBuffer);
                console.log('å›¾åƒæ•°æ®åŠ è½½å®Œæˆ, ç»´åº¦:', header.dim.slice(1, 4), 'æ•°æ®ç±»å‹:', header.datatype);
                
                // åˆå§‹åŒ–2Dåˆ‡ç‰‡æŸ¥çœ‹å™¨
                initSliceViewer(imageData, header);
                
            } catch (error) {
                console.error('è§£æNIfTIæ–‡ä»¶å¤±è´¥:', error);
                showError('æ— æ³•è§£æNIfTIæ–‡ä»¶: ' + error.message);
                // æ˜¾ç¤ºç®€åŒ–æŸ¥çœ‹å™¨ä½œä¸ºå¤‡ç”¨
                initSimpleViewer();
            }
        })
        .catch(error => {
            console.error('åŠ è½½æ–‡ä»¶å¤±è´¥:', error);
            showError('æ— æ³•åŠ è½½å½±åƒæ–‡ä»¶: ' + error.message);
            // æ˜¾ç¤ºç®€åŒ–æŸ¥çœ‹å™¨ä½œä¸ºå¤‡ç”¨
            initSimpleViewer();
        });
}

// åˆå§‹åŒ–2Dåˆ‡ç‰‡æŸ¥çœ‹å™¨
function initSliceViewer(data, niftiHeader) {
    try {
        console.log('åˆå§‹åŒ–2Dåˆ‡ç‰‡æŸ¥çœ‹å™¨');
        
        // éšè—åŠ è½½ç•Œé¢ï¼Œæ˜¾ç¤ºåˆ‡ç‰‡æŸ¥çœ‹å™¨
        document.getElementById('loading-placeholder').style.display = 'none';
        document.getElementById('slice-viewer').style.display = 'block';
        
        // ä¿å­˜æ•°æ®
        volumeData = data;
        header = niftiHeader;
        
        // è·å–Canvas
        canvas = document.getElementById('slice-canvas');
        ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;
        
        // è®¾ç½®åˆå§‹å‚æ•°
        const width = header.dim[1];
        const height = header.dim[2];
        const depth = header.dim[3];
        
        currentSlice = Math.floor(depth / 2); // ä»ä¸­é—´åˆ‡ç‰‡å¼€å§‹
        
        // æ›´æ–°UIä¿¡æ¯
        updateImageInfo();
        updateWindowLevelDisplay();
        setupSliceNavigation();
        
        // æ¸²æŸ“åˆå§‹åˆ‡ç‰‡
        renderSlice();
        
        console.log('âœ… 2Dåˆ‡ç‰‡æŸ¥çœ‹å™¨åˆå§‹åŒ–æˆåŠŸ');
        
    } catch (error) {
        console.error('åˆå§‹åŒ–åˆ‡ç‰‡æŸ¥çœ‹å™¨å¤±è´¥:', error);
        showError('åˆå§‹åŒ–2DæŸ¥çœ‹å™¨å¤±è´¥: ' + error.message);
    }
}

// è®¾ç½®åˆ‡ç‰‡å¯¼èˆªæ§ä»¶
function setupSliceNavigation() {
    if (!header) return;
    
    const depth = getCurrentPlaneDepth();
    const slider = document.getElementById('slice-slider');
    const firstBtn = document.getElementById('first-slice-btn');
    const prevBtn = document.getElementById('prev-slice-btn');
    const nextBtn = document.getElementById('next-slice-btn');
    const lastBtn = document.getElementById('last-slice-btn');
    
    // è®¾ç½®æ»‘åŠ¨æ¡èŒƒå›´
    slider.min = 0;
    slider.max = depth - 1;
    slider.value = currentSlice;
    
    // æ»‘åŠ¨æ¡äº‹ä»¶
    slider.addEventListener('input', function() {
        currentSlice = parseInt(this.value);
        renderSlice();
        updateSliceInfo();
    });
    
    // æŒ‰é’®äº‹ä»¶
    firstBtn.addEventListener('click', () => {
        currentSlice = 0;
        slider.value = currentSlice;
        renderSlice();
        updateSliceInfo();
    });
    
    prevBtn.addEventListener('click', () => {
        if (currentSlice > 0) {
            currentSlice--;
            slider.value = currentSlice;
            renderSlice();
            updateSliceInfo();
        }
    });
    
    nextBtn.addEventListener('click', () => {
        if (currentSlice < depth - 1) {
            currentSlice++;
            slider.value = currentSlice;
            renderSlice();
            updateSliceInfo();
        }
    });
    
    lastBtn.addEventListener('click', () => {
        currentSlice = depth - 1;
        slider.value = currentSlice;
        renderSlice();
        updateSliceInfo();
    });
    
    // é¼ æ ‡æ»šè½®äº‹ä»¶
    canvas.addEventListener('wheel', function(e) {
        e.preventDefault();
        const delta = e.deltaY > 0 ? 1 : -1;
        const newSlice = currentSlice + delta;
        
        if (newSlice >= 0 && newSlice < depth) {
            currentSlice = newSlice;
            slider.value = currentSlice;
            renderSlice();
            updateSliceInfo();
        }
    });
    
    // è§†å›¾æ–¹å‘åˆ‡æ¢
    const viewButtons = document.querySelectorAll('input[name="view-plane"]');
    viewButtons.forEach(button => {
        button.addEventListener('change', function() {
            if (this.checked) {
                currentPlane = this.value;
                currentSlice = Math.floor(getCurrentPlaneDepth() / 2);
                setupSliceNavigation(); // é‡æ–°è®¾ç½®å¯¼èˆª
                renderSlice();
                updateSliceInfo();
                updateViewPlaneInfo();
            }
        });
    });
    
    // å¿«æ·é”®æ”¯æŒ
    document.addEventListener('keydown', function(e) {
        if (!canvas.matches(':hover')) return;
        
        switch(e.key) {
            case 'ArrowUp':
            case 'ArrowLeft':
                e.preventDefault();
                if (currentSlice > 0) {
                    currentSlice--;
                    slider.value = currentSlice;
                    renderSlice();
                    updateSliceInfo();
                }
                break;
            case 'ArrowDown':
            case 'ArrowRight':
                e.preventDefault();
                if (currentSlice < depth - 1) {
                    currentSlice++;
                    slider.value = currentSlice;
                    renderSlice();
                    updateSliceInfo();
                }
                break;
        }
    });
    
    // ç»‘å®šé‡ç½®è§†å›¾æŒ‰é’®
    const resetBtn = document.getElementById('reset-view-btn');
    if (resetBtn) {
        resetBtn.addEventListener('click', resetView);
    }
    
    // ç»‘å®šä¿å­˜æˆªå›¾æŒ‰é’®
    const saveBtn = document.getElementById('save-slice-btn');
    if (saveBtn) {
        saveBtn.addEventListener('click', saveCurrentSlice);
    }
}

// è·å–å½“å‰å¹³é¢çš„æ·±åº¦
function getCurrentPlaneDepth() {
    if (!header) return 0;
    
    switch(currentPlane) {
        case 'axial': return header.dim[3]; // Zè½´
        case 'sagittal': return header.dim[1]; // Xè½´  
        case 'coronal': return header.dim[2]; // Yè½´
        default: return header.dim[3];
    }
}

// æ¸²æŸ“å½“å‰åˆ‡ç‰‡
function renderSlice() {
    if (!volumeData || !header || !canvas || !ctx) return;
    
    try {
        const width = header.dim[1];
        const height = header.dim[2];
        const depth = header.dim[3];
        
        let sliceWidth, sliceHeight, sliceData;
        
        // æ ¹æ®å½“å‰è§†å›¾æ–¹å‘æå–åˆ‡ç‰‡æ•°æ®
        switch(currentPlane) {
            case 'axial':
                sliceWidth = width;
                sliceHeight = height;
                sliceData = extractAxialSlice(currentSlice);
                break;
            case 'sagittal':
                sliceWidth = height;
                sliceHeight = depth;
                sliceData = extractSagittalSlice(currentSlice);
                break;
            case 'coronal':
                sliceWidth = width;
                sliceHeight = depth;
                sliceData = extractCoronalSlice(currentSlice);
                break;
            default:
                sliceWidth = width;
                sliceHeight = height;
                sliceData = extractAxialSlice(currentSlice);
        }
        
        // è®¡ç®—é«˜åˆ†è¾¨ç‡æ¸²æŸ“å°ºå¯¸
        const devicePixelRatio = window.devicePixelRatio || 1;
        const container = canvas.parentElement;
        const containerWidth = container.clientWidth - 20;
        const containerHeight = container.clientHeight - 20;
        
        // è®¡ç®—æœ€ä½³æ˜¾ç¤ºå°ºå¯¸
        const aspectRatio = sliceWidth / sliceHeight;
        let displayWidth, displayHeight;
        
        if (containerWidth / containerHeight > aspectRatio) {
            displayHeight = containerHeight;
            displayWidth = displayHeight * aspectRatio;
        } else {
            displayWidth = containerWidth;
            displayHeight = displayWidth / aspectRatio;
        }
        
        // è®¾ç½®Canvaså®é™…æ¸²æŸ“å°ºå¯¸ï¼ˆè€ƒè™‘è®¾å¤‡åƒç´ æ¯”ï¼‰
        const renderWidth = Math.floor(displayWidth * devicePixelRatio);
        const renderHeight = Math.floor(displayHeight * devicePixelRatio);
        
        canvas.width = renderWidth;
        canvas.height = renderHeight;
        
        // è®¾ç½®Canvas CSSæ˜¾ç¤ºå°ºå¯¸
        canvas.style.width = displayWidth + 'px';
        canvas.style.height = displayHeight + 'px';
        
        // ç¼©æ”¾ä¸Šä¸‹æ–‡ä»¥åŒ¹é…è®¾å¤‡åƒç´ æ¯”
        ctx.scale(devicePixelRatio, devicePixelRatio);
        
        // ä½¿ç”¨åŒçº¿æ€§æ’å€¼æé«˜å›¾åƒè´¨é‡
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        
        // åˆ›å»ºé«˜åˆ†è¾¨ç‡å›¾åƒæ•°æ®
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = sliceWidth;
        tempCanvas.height = sliceHeight;
        const tempCtx = tempCanvas.getContext('2d');
        tempCtx.imageSmoothingEnabled = false;
        
        const imageData = tempCtx.createImageData(sliceWidth, sliceHeight);
        const data = imageData.data;
        
        // åº”ç”¨çª—å®½çª—ä½å¹¶è½¬æ¢ä¸ºRGBA
        for (let i = 0; i < sliceData.length; i++) {
            const value = applyWindowLeveltoValue(sliceData[i]);
            const pixelIndex = i * 4;
            
            data[pixelIndex] = value;     // R
            data[pixelIndex + 1] = value; // G
            data[pixelIndex + 2] = value; // B
            data[pixelIndex + 3] = 255;   // A
        }
        
        // å…ˆç»˜åˆ¶åˆ°ä¸´æ—¶Canvas
        tempCtx.putImageData(imageData, 0, 0);
        
        // ç„¶åç¼©æ”¾ç»˜åˆ¶åˆ°ä¸»Canvasï¼Œå®ç°é«˜è´¨é‡æ’å€¼
        ctx.clearRect(0, 0, displayWidth, displayHeight);
        ctx.drawImage(tempCanvas, 0, 0, sliceWidth, sliceHeight, 
                     0, 0, displayWidth, displayHeight);
        
    } catch (error) {
        console.error('æ¸²æŸ“åˆ‡ç‰‡å¤±è´¥:', error);
    }
}

// æå–è½´ä½åˆ‡ç‰‡ï¼ˆZæ–¹å‘ï¼‰
function extractAxialSlice(sliceIndex) {
    const width = header.dim[1];
    const height = header.dim[2];
    const sliceSize = width * height;
    const startIndex = sliceIndex * sliceSize;
    
    return volumeData.slice(startIndex, startIndex + sliceSize);
}

// æå–çŸ¢çŠ¶ä½åˆ‡ç‰‡ï¼ˆXæ–¹å‘ï¼‰
function extractSagittalSlice(sliceIndex) {
    const width = header.dim[1];
    const height = header.dim[2];
    const depth = header.dim[3];
    const sliceData = new Float32Array(height * depth);
    
    for (let z = 0; z < depth; z++) {
        for (let y = 0; y < height; y++) {
            const volumeIndex = z * width * height + y * width + sliceIndex;
            const sliceDataIndex = z * height + y;
            sliceData[sliceDataIndex] = volumeData[volumeIndex];
        }
    }
    
    return sliceData;
}

// æå–å† çŠ¶ä½åˆ‡ç‰‡ï¼ˆYæ–¹å‘ï¼‰
function extractCoronalSlice(sliceIndex) {
    const width = header.dim[1];
    const height = header.dim[2];
    const depth = header.dim[3];
    const sliceData = new Float32Array(width * depth);
    
    for (let z = 0; z < depth; z++) {
        for (let x = 0; x < width; x++) {
            const volumeIndex = z * width * height + sliceIndex * width + x;
            const sliceDataIndex = z * width + x;
            sliceData[sliceDataIndex] = volumeData[volumeIndex];
        }
    }
    
    return sliceData;
}

// åº”ç”¨çª—å®½çª—ä½
function applyWindowLeveltoValue(value) {
    const minValue = windowLevel - windowWidth / 2;
    const maxValue = windowLevel + windowWidth / 2;
    
    if (value <= minValue) return 0;
    if (value >= maxValue) return 255;
    
    return Math.round(((value - minValue) / windowWidth) * 255);
}

// è°ƒæ•´Canvasæ˜¾ç¤ºå°ºå¯¸ï¼ˆé«˜DPIä¼˜åŒ–ï¼‰
function resizeCanvas() {
    const container = canvas.parentElement;
    const containerWidth = container.clientWidth - 20;
    const containerHeight = container.clientHeight - 20;
    
    // è·å–è®¾å¤‡åƒç´ æ¯”ä¾‹ï¼Œæ”¯æŒé«˜DPIæ˜¾ç¤º
    const devicePixelRatio = window.devicePixelRatio || 1;
    
    const aspectRatio = canvas.width / canvas.height;
    let displayWidth, displayHeight;
    
    if (containerWidth / containerHeight > aspectRatio) {
        displayHeight = containerHeight;
        displayWidth = displayHeight * aspectRatio;
    } else {
        displayWidth = containerWidth;
        displayHeight = displayWidth / aspectRatio;
    }
    
    // è®¾ç½®Canvasçš„CSSæ˜¾ç¤ºå°ºå¯¸
    canvas.style.width = displayWidth + 'px';
    canvas.style.height = displayHeight + 'px';
    
    // ä¸ºé«˜DPIæ˜¾ç¤ºä¼˜åŒ–Canvaså®é™…å°ºå¯¸
    const scaledWidth = Math.floor(displayWidth * devicePixelRatio);
    const scaledHeight = Math.floor(displayHeight * devicePixelRatio);
    
    // åªæœ‰åœ¨å°ºå¯¸ç¡®å®æ”¹å˜æ—¶æ‰é‡æ–°æ¸²æŸ“
    if (canvas.style.width !== displayWidth + 'px' || 
        canvas.getAttribute('data-scaled-width') !== scaledWidth.toString()) {
        
        canvas.setAttribute('data-scaled-width', scaledWidth.toString());
        canvas.setAttribute('data-scaled-height', scaledHeight.toString());
        
        // é‡æ–°æ¸²æŸ“å½“å‰åˆ‡ç‰‡ä»¥é€‚åº”æ–°å°ºå¯¸
        renderSlice();
    }
}

// æ›´æ–°å›¾åƒä¿¡æ¯
function updateImageInfo() {
    if (!header) return;
    
    const dims = `${header.dim[1]}Ã—${header.dim[2]}Ã—${header.dim[3]}`;
    const spacing = `${header.pixdim[1]?.toFixed(2)}Ã—${header.pixdim[2]?.toFixed(2)}Ã—${header.pixdim[3]?.toFixed(2)}mm`;
    const datatype = getDataTypeName(header.datatype);
    
    document.getElementById('dimensions-display').textContent = dims;
    document.getElementById('spacing-display').textContent = spacing;
    document.getElementById('datatype-display').textContent = datatype;
}

// æ›´æ–°åˆ‡ç‰‡ä¿¡æ¯
function updateSliceInfo() {
    const depth = getCurrentPlaneDepth();
    document.getElementById('slice-info').textContent = `åˆ‡ç‰‡ ${currentSlice + 1} / ${depth}`;
    document.getElementById('current-slice').textContent = currentSlice + 1;
    document.getElementById('total-slices').textContent = depth;
}

// æ›´æ–°è§†å›¾æ–¹å‘ä¿¡æ¯
function updateViewPlaneInfo() {
    const planeNames = {
        'axial': 'è½´ä½è§†å›¾',
        'sagittal': 'çŸ¢çŠ¶ä½è§†å›¾', 
        'coronal': 'å† çŠ¶ä½è§†å›¾'
    };
    document.getElementById('view-plane-info').textContent = planeNames[currentPlane];
}

// é‡ç½®è§†å›¾åŠŸèƒ½
function resetView() {
    if (!header) return;
    
    // é‡ç½®åˆ°è½´ä½è§†å›¾
    currentPlane = 'axial';
    document.getElementById('axial-view').checked = true;
    
    // é‡ç½®åˆ°ä¸­é—´åˆ‡ç‰‡
    const depth = getCurrentPlaneDepth();
    currentSlice = Math.floor(depth / 2);
    
    // é‡ç½®çª—å®½çª—ä½
    windowWidth = 400;
    windowLevel = 40;
    
    // æ›´æ–°UI
    setupSliceNavigation();
    renderSlice();
    updateSliceInfo();
    updateViewPlaneInfo();
    updateWindowLevelDisplay();
    
    console.log('è§†å›¾å·²é‡ç½®åˆ°é»˜è®¤çŠ¶æ€');
}

// æ›´æ–°çª—å®½çª—ä½æ˜¾ç¤º
function updateWindowLevelDisplay() {
    document.getElementById('window-level-info').textContent = `${windowWidth}/${windowLevel}`;
}

// ä¿å­˜å½“å‰åˆ‡ç‰‡æˆªå›¾
function saveCurrentSlice() {
    if (!canvas || !header) {
        alert('æ²¡æœ‰å¯ç”¨çš„å›¾åƒæ•°æ®');
        return;
    }
    
    try {
        // åˆ›å»ºä¸€ä¸ªç”¨äºå¯¼å‡ºçš„Canvas
        const exportCanvas = document.createElement('canvas');
        const exportCtx = exportCanvas.getContext('2d');
        
        // è®¾ç½®å¯¼å‡ºCanvaså°ºå¯¸ä¸ºåŸå§‹å›¾åƒå°ºå¯¸
        const originalWidth = canvas.width / (window.devicePixelRatio || 1);
        const originalHeight = canvas.height / (window.devicePixelRatio || 1);
        
        exportCanvas.width = originalWidth;
        exportCanvas.height = originalHeight;
        
        // ç»˜åˆ¶å½“å‰Canvaså†…å®¹åˆ°å¯¼å‡ºCanvas
        exportCtx.drawImage(canvas, 0, 0, originalWidth, originalHeight);
        
        // æ·»åŠ åŒ»å­¦ä¿¡æ¯å åŠ å±‚
        addMedicalInfoOverlay(exportCtx, originalWidth, originalHeight);
        
        // è½¬æ¢ä¸ºBlobå¹¶ä¸‹è½½
        exportCanvas.toBlob(function(blob) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            // ç”Ÿæˆæ–‡ä»¶å
            const patientId = document.getElementById('patient-id-display').textContent || 'Patient';
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            const planeNames = { 'axial': 'è½´ä½', 'sagittal': 'çŸ¢çŠ¶ä½', 'coronal': 'å† çŠ¶ä½' };
            const planeName = planeNames[currentPlane] || 'åˆ‡ç‰‡';
            
            link.download = `${patientId}_${planeName}_åˆ‡ç‰‡${currentSlice + 1}_${timestamp}.png`;
            link.href = url;
            
            // æ¨¡æ‹Ÿç‚¹å‡»ä¸‹è½½
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // æ¸…ç†URLå¯¹è±¡
            URL.revokeObjectURL(url);
            
            console.log(`æˆªå›¾å·²ä¿å­˜: ${link.download}`);
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showSaveSuccessToast();
            
        }, 'image/png', 0.95);
        
    } catch (error) {
        console.error('ä¿å­˜æˆªå›¾å¤±è´¥:', error);
        alert('ä¿å­˜æˆªå›¾å¤±è´¥: ' + error.message);
    }
}

// æ·»åŠ åŒ»å­¦ä¿¡æ¯å åŠ å±‚åˆ°å¯¼å‡ºå›¾åƒ
function addMedicalInfoOverlay(ctx, width, height) {
    // è®¾ç½®æ–‡å­—æ ·å¼
    ctx.fillStyle = 'white';
    ctx.strokeStyle = 'black';
    ctx.lineWidth = 2;
    ctx.font = '14px Arial, sans-serif';
    
    // å‡†å¤‡ä¿¡æ¯æ–‡æœ¬
    const patientId = document.getElementById('patient-id-display').textContent || 'Unknown';
    const dims = document.getElementById('dimensions-display').textContent || '-';
    const spacing = document.getElementById('spacing-display').textContent || '-';
    const planeNames = { 'axial': 'è½´ä½', 'sagittal': 'çŸ¢çŠ¶ä½', 'coronal': 'å† çŠ¶ä½' };
    const planeName = planeNames[currentPlane] || 'åˆ‡ç‰‡';
    const sliceInfo = `${planeName} ${currentSlice + 1}/${getCurrentPlaneDepth()}`;
    const timestamp = new Date().toLocaleString('zh-CN');
    
    const infoLines = [
        `æ‚£è€…ID: ${patientId}`,
        `${sliceInfo}`,
        `ç»´åº¦: ${dims}`,
        `é—´è·: ${spacing}`,
        `çª—å®½/çª—ä½: ${windowWidth}/${windowLevel}`,
        `å¯¼å‡ºæ—¶é—´: ${timestamp}`
    ];
    
    // ç»˜åˆ¶ä¿¡æ¯æ–‡æœ¬ï¼ˆå³ä¸Šè§’ï¼‰
    const lineHeight = 18;
    const margin = 10;
    const startY = margin + lineHeight;
    
    for (let i = 0; i < infoLines.length; i++) {
        const y = startY + i * lineHeight;
        const textWidth = ctx.measureText(infoLines[i]).width;
        const x = width - textWidth - margin;
        
        // ç»˜åˆ¶æ–‡å­—æè¾¹å’Œå¡«å……
        ctx.strokeText(infoLines[i], x, y);
        ctx.fillText(infoLines[i], x, y);
    }
    
    // ç»˜åˆ¶æ¯”ä¾‹å°ºï¼ˆå·¦ä¸‹è§’ï¼‰
    if (header && header.pixdim && header.pixdim[1]) {
        const pixelSpacing = header.pixdim[1]; // mm per pixel
        const scaleLength = 50; // 50mm scale bar
        const scalePixels = scaleLength / pixelSpacing;
        
        const scaleX = margin;
        const scaleY = height - margin - 20;
        
        // ç»˜åˆ¶æ¯”ä¾‹å°ºçº¿æ¡
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(scaleX, scaleY);
        ctx.lineTo(scaleX + scalePixels, scaleY);
        ctx.stroke();
        
        // ç»˜åˆ¶æ¯”ä¾‹å°ºæ–‡å­—
        ctx.fillStyle = 'white';
        ctx.font = '12px Arial, sans-serif';
        ctx.fillText(`${scaleLength}mm`, scaleX, scaleY + 15);
    }
}

// æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
function showSaveSuccessToast() {
    // åˆ›å»ºæç¤ºå…ƒç´ 
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        font-weight: 500;
        opacity: 0;
        transform: translateX(100px);
        transition: all 0.3s ease;
    `;
    
    toast.innerHTML = `
        <i class="bi bi-check-circle me-2"></i>
        æˆªå›¾å·²ä¿å­˜åˆ°ä¸‹è½½æ–‡ä»¶å¤¹
    `;
    
    document.body.appendChild(toast);
    
    // åŠ¨ç”»æ˜¾ç¤º
    setTimeout(() => {
        toast.style.opacity = '1';
        toast.style.transform = 'translateX(0)';
    }, 100);
    
    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(100px)';
        setTimeout(() => {
            document.body.removeChild(toast);
        }, 300);
    }, 3000);
}

function createVolumeRendering(imageData, header) {
    try {
        // è·å–ç»´åº¦ä¿¡æ¯
        const width = header.dim[1];
        const height = header.dim[2];
        const depth = header.dim[3];
        
        console.log(`åˆ›å»ºåŒ»å­¦å½±åƒä½“ç§¯æ¸²æŸ“: ${width}x${height}x${depth}`);
        
        // æ ‡å‡†åŒ–æ•°æ®åˆ°0-255èŒƒå›´
        const normalizedData = normalizeImageData(imageData, header);
        
        // åˆ›å»ºåˆ‡ç‰‡æ¸²æŸ“ï¼ˆæ›´å¯é çš„æ–¹æ³•ï¼‰
        createSliceBasedVisualization(normalizedData, width, height, depth, header);
        
        // æ·»åŠ ä¿¡æ¯è¦†ç›–å±‚
        addVolumeInfoOverlay(header);
        
        console.log('âœ… åŒ»å­¦å½±åƒå¯è§†åŒ–åˆ›å»ºæˆåŠŸ');
        
    } catch (error) {
        console.error('åˆ›å»ºä½“ç§¯æ¸²æŸ“å¤±è´¥:', error);
        showError('åˆ›å»ºä½“ç§¯æ¸²æŸ“å¤±è´¥: ' + error.message);
        // å›é€€åˆ°æ¼”ç¤ºæ¨¡å¼
        createDemoMedicalVisualization();
    }
}

function normalizeImageData(data, header) {
    // æ‰¾åˆ°æ•°æ®çš„æœ€å°å€¼å’Œæœ€å¤§å€¼
    let min = Infinity;
    let max = -Infinity;
    
    for (let i = 0; i < data.length; i++) {
        const value = data[i];
        if (value < min) min = value;
        if (value > max) max = value;
    }
    
    console.log(`æ•°æ®èŒƒå›´: ${min} åˆ° ${max}`);
    
    // æ ‡å‡†åŒ–åˆ°0-255èŒƒå›´
    const normalized = new Uint8Array(data.length);
    const range = max - min;
    
    if (range > 0) {
        for (let i = 0; i < data.length; i++) {
            normalized[i] = Math.floor(((data[i] - min) / range) * 255);
        }
    } else {
        // æ‰€æœ‰å€¼ç›¸åŒçš„æƒ…å†µ
        normalized.fill(128);
    }
    
    return normalized;
}

function createSliceBasedVisualization(data, width, height, depth, header) {
    // åˆ›å»ºå¤šä¸ªåˆ‡ç‰‡å¹³é¢æ¥æ˜¾ç¤º3Dæ•°æ®
    const sliceSpacing = Math.max(width, height, depth) / Math.min(depth, 10);
    
    for (let z = 0; z < depth; z += Math.max(1, Math.floor(depth / 10))) {
        // æå–Zåˆ‡ç‰‡æ•°æ®
        const sliceData = new Uint8Array(width * height);
        for (let y = 0; y < height; y++) {
            for (let x = 0; x < width; x++) {
                const index3D = z * width * height + y * width + x;
                const index2D = y * width + x;
                sliceData[index2D] = data[index3D] || 0;
            }
        }
        
        // åˆ›å»ºçº¹ç†
        const canvas = document.createElement('canvas');
        canvas.width = width;
        canvas.height = height;
        const ctx = canvas.getContext('2d');
        const imageData = ctx.createImageData(width, height);
        
        // åˆ›å»ºç°åº¦å›¾åƒ
        for (let i = 0; i < sliceData.length; i++) {
            const value = sliceData[i];
            imageData.data[i * 4] = value;     // R
            imageData.data[i * 4 + 1] = value; // G  
            imageData.data[i * 4 + 2] = value; // B
            imageData.data[i * 4 + 3] = 255;   // A
        }
        
        ctx.putImageData(imageData, 0, 0);
        
        // åˆ›å»ºThree.jsçº¹ç†
        const texture = new THREE.CanvasTexture(canvas);
        texture.needsUpdate = true;
        
        // åˆ›å»ºåŠé€æ˜å¹³é¢
        const planeGeometry = new THREE.PlaneGeometry(width, height);
        const planeMaterial = new THREE.MeshBasicMaterial({
            map: texture,
            transparent: true,
            opacity: 0.8,
            side: THREE.DoubleSide
        });
        
        const plane = new THREE.Mesh(planeGeometry, planeMaterial);
        plane.position.z = (z - depth/2) * (depth / 10);
        
        scene.add(plane);
    }
    
    // è°ƒæ•´ç›¸æœº
    const maxDim = Math.max(width, height, depth);
    camera.position.set(maxDim * 0.8, maxDim * 0.8, maxDim * 1.2);
    camera.lookAt(0, 0, 0);
    controls.target.set(0, 0, 0);
    controls.update();
}

function addVolumeInfoOverlay(header) {
    const container = document.getElementById('nifti-viewer');
    const overlay = document.createElement('div');
    overlay.style.cssText = `
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(45, 90, 160, 0.95);
        color: white;
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 0.85rem;
        z-index: 100;
        max-width: 280px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    `;
    
    overlay.innerHTML = `
        <strong>ğŸ”¬ çœŸå®NIfTIæ•°æ®</strong><br>
        <small>
        ç»´åº¦: ${header.dim[1]}Ã—${header.dim[2]}Ã—${header.dim[3]}<br>
        æ•°æ®ç±»å‹: ${getDataTypeName(header.datatype)}<br>
        åƒç´ é—´è·: ${header.pixdim[1]?.toFixed(2)}mm<br>
        æ–‡ä»¶å¤´å¤§å°: ${header.sizeof_hdr} bytes
        </small><br>
        <em>æ‹–æ‹½æ—‹è½¬ â€¢ æ»šè½®ç¼©æ”¾</em>
    `;
    container.appendChild(overlay);
}

function getDataTypeName(datatype) {
    const types = {
        2: 'uint8', 4: 'int16', 8: 'int32', 
        16: 'float32', 64: 'float64'
    };
    return types[datatype] || `type-${datatype}`;
}



function getVolumeVertexShader() {
    return `
        varying vec3 vWorldPosition;
        varying vec3 vLocalPosition;
        
        void main() {
            vLocalPosition = position + 0.5;
            vWorldPosition = (modelMatrix * vec4(position, 1.0)).xyz;
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
    `;
}

function getVolumeFragmentShader() {
    return `
        uniform sampler3D volumeTexture;
        uniform float threshold;
        uniform float opacity;
        uniform float steps;
        
        varying vec3 vWorldPosition;
        varying vec3 vLocalPosition;
        
        void main() {
            vec3 rayDirection = normalize(vWorldPosition - cameraPosition);
            vec3 rayStart = vLocalPosition;
            
            float stepSize = 1.0 / steps;
            vec3 step = rayDirection * stepSize;
            vec3 currentPos = rayStart;
            
            vec4 color = vec4(0.0);
            
            for (float i = 0.0; i < steps; i++) {
                if (currentPos.x < 0.0 || currentPos.x > 1.0 ||
                    currentPos.y < 0.0 || currentPos.y > 1.0 ||
                    currentPos.z < 0.0 || currentPos.z > 1.0) break;
                
                float density = texture(volumeTexture, currentPos).r;
                
                if (density > threshold) {
                    vec3 sampleColor = vec3(density);
                    float alpha = density * opacity;
                    
                    color.rgb += sampleColor * alpha * (1.0 - color.a);
                    color.a += alpha * (1.0 - color.a);
                    
                    if (color.a > 0.95) break;
                }
                
                currentPos += step;
            }
            
            gl_FragColor = color;
        }
    `;
}

function animate() {
    requestAnimationFrame(animate);
    
    if (controls) {
        controls.update();
    }
    
    if (renderer && scene && camera) {
        renderer.render(scene, camera);
    }
}

function resetView() {
    if (camera && controls) {
        camera.position.set(300, 300, 300);
        camera.lookAt(0, 0, 0);
        controls.target.set(0, 0, 0);
        controls.update();
    }
}

function toggleFullscreen() {
    const container = document.getElementById('nifti-viewer');
    if (!document.fullscreenElement) {
        container.requestFullscreen().catch(err => {
            console.error('æ— æ³•è¿›å…¥å…¨å±æ¨¡å¼:', err);
        });
    } else {
        document.exitFullscreen();
    }
}

function captureScreenshot() {
    if (renderer) {
        const link = document.createElement('a');
        link.download = 'medical_image_screenshot.png';
        link.href = renderer.domElement.toDataURL();
        link.click();
    }
}

function showError(message) {
    const container = document.getElementById('nifti-viewer');
    container.innerHTML = `
        <div class="viewer-placeholder">
            <i class="bi bi-exclamation-triangle-fill" style="color: #ff8a95;"></i>
            <h5>WebGLæŸ¥çœ‹å™¨æš‚æ—¶ä¸å¯ç”¨</h5>
            <p>${message}</p>
            <div class="error-message">
                <i class="bi bi-info-circle"></i>
                <span>æ‚¨å¯ä»¥ä¸‹è½½æ–‡ä»¶åä½¿ç”¨ä¸“ä¸šåŒ»å­¦å½±åƒè½¯ä»¶æŸ¥çœ‹</span>
            </div>
            <div style="margin-top: 2rem;">
                <h6 style="color: var(--text-primary); margin-bottom: 1rem;">æ¨èè½¯ä»¶:</h6>
                <ul style="text-align: left; display: inline-block;">
                    <li><strong>ITK-SNAP</strong> - å…è´¹åŒ»å­¦å½±åƒæŸ¥çœ‹å™¨</li>
                    <li><strong>3D Slicer</strong> - ä¸“ä¸šåŒ»å­¦å½±åƒå¤„ç†å¹³å°</li>
                    <li><strong>MRIcron</strong> - è½»é‡çº§NIfTIæŸ¥çœ‹å™¨</li>
                </ul>
            </div>
        </div>
    `;
}

// å¤‡ç”¨çš„ç®€åŒ–æŸ¥çœ‹å™¨
function initSimpleViewer() {
    if (viewerInitialized) return;
    
    console.log('åˆå§‹åŒ–ç®€åŒ–æŸ¥çœ‹å™¨');
    const container = document.getElementById('nifti-viewer');
    const imageUrl = '{{ image_url|default:"" }}';
    const downloadUrl = '{{ patient_info.image.url|default:"#" }}';
    
    container.innerHTML = `
        <div class="viewer-placeholder">
            <i class="bi bi-file-earmark-medical" style="color: #5ba3e6; font-size: 5rem; margin-bottom: 2rem;"></i>
            <h5 style="color: #2d5aa0; margin-bottom: 1rem;">NIfTIåŒ»å­¦å½±åƒæ–‡ä»¶</h5>
            <p style="color: #5b7db8; margin-bottom: 2rem;">WebGL 3DæŸ¥çœ‹å™¨æš‚æ—¶ä¸å¯ç”¨</p>
            <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                <a href="${downloadUrl}" download style="
                    background: linear-gradient(135deg, #87ceeb 0%, #b3d9ff 100%);
                    border: none;
                    border-radius: 30px;
                    padding: 15px 35px;
                    color: #2d5aa0;
                    font-weight: 600;
                    text-decoration: none;
                    display: inline-flex;
                    align-items: center;
                    box-shadow: 0 5px 25px rgba(91, 163, 230, 0.12);
                ">
                    <i class="bi bi-download me-2"></i>ä¸‹è½½å½±åƒæ–‡ä»¶
                </a>
                <button onclick="retryWebGLViewer()" style="
                    background: linear-gradient(135deg, #90cdf4 0%, #b3d9ff 100%);
                    border: 2px solid #5ba3e6;
                    border-radius: 30px;
                    padding: 13px 30px;
                    color: #2d5aa0;
                    font-weight: 600;
                    cursor: pointer;
                    display: inline-flex;
                    align-items: center;
                    box-shadow: 0 5px 25px rgba(91, 163, 230, 0.08);
                ">
                    <i class="bi bi-arrow-clockwise me-2"></i>é‡è¯•3DæŸ¥çœ‹å™¨
                </button>
            </div>
            <div style="
                background: linear-gradient(135deg, #fff9e6 0%, #ffeecc 100%);
                border: 1px solid #ffd93d;
                border-radius: 12px;
                color: #cc8800;
                padding: 1.5rem;
                margin-top: 2rem;
                text-align: left;
            ">
                <h6 style="color: #cc8800; margin-bottom: 1rem;">
                    <i class="bi bi-info-circle me-2"></i>æ¨èæŸ¥çœ‹è½¯ä»¶
                </h6>
                <ul style="margin: 0; padding-left: 1.5rem;">
                    <li style="margin-bottom: 0.5rem;"><strong>ITK-SNAP</strong> - å…è´¹åŒ»å­¦å½±åƒåˆ†å‰²æŸ¥çœ‹è½¯ä»¶</li>
                    <li style="margin-bottom: 0.5rem;"><strong>3D Slicer</strong> - ä¸“ä¸šåŒ»å­¦å½±åƒå¤„ç†å¹³å°</li>
                    <li style="margin-bottom: 0.5rem;"><strong>MRIcron</strong> - è½»é‡çº§NIfTIæŸ¥çœ‹å™¨</li>
                </ul>
            </div>
        </div>
    `;
}

// è·³è¿‡åŠ è½½ï¼Œç›´æ¥ä½¿ç”¨ç®€åŒ–æŸ¥çœ‹å™¨
function skipToSimpleViewer() {
    console.log('ğŸ‘† ç”¨æˆ·æ‰‹åŠ¨è·³è¿‡åŠ è½½');
    if (!viewerInitialized) {
        initSimpleViewer();
        viewerInitialized = true;
    }
}

// é‡è¯•WebGLæŸ¥çœ‹å™¨
function retryWebGLViewer() {
    console.log('ç”¨æˆ·æ‰‹åŠ¨é‡è¯•WebGLæŸ¥çœ‹å™¨');
    viewerInitialized = false;
    
    const container = document.getElementById('nifti-viewer');
    container.innerHTML = `
        <div class="viewer-placeholder">
            <div class="loading-spinner"></div>
            <h5>é‡æ–°å°è¯•åŠ è½½WebGLæŸ¥çœ‹å™¨</h5>
            <div class="progress-container">
                <div class="progress-bar"></div>
            </div>
            <p>æ­£åœ¨é‡æ–°åˆå§‹åŒ–3Dæ¸²æŸ“å™¨<span class="pulse-dot">.</span><span class="pulse-dot">.</span><span class="pulse-dot">.</span></p>
        </div>
    `;
    
    setTimeout(() => {
        if (window.THREE && window.THREE.OrbitControls && window.nifti) {
            initNiftiViewer();
        } else {
            console.log('åº“ä»æœªåŠ è½½ï¼Œå›é€€åˆ°ç®€åŒ–æŸ¥çœ‹å™¨');
            initSimpleViewer();
            viewerInitialized = true;
        }
    }, 1000);
}

// ç›‘å¬çª—å£å¤§å°å˜åŒ–
window.addEventListener('resize', function() {
    if (canvas && ctx && volumeData) {
        // é‡æ–°æ¸²æŸ“ä»¥é€‚åº”æ–°çš„çª—å£å°ºå¯¸
        setTimeout(() => {
            renderSlice();
        }, 100);
    }
});
</script>
{% endblock %}
